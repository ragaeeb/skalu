<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Skalu Demo</title>
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f5f5f5;
        color: #1b1b1b;
        display: flex;
        min-height: 100vh;
      }
      .container {
        margin: auto;
        width: min(960px, 90vw);
        background: white;
        padding: 2.5rem;
        border-radius: 16px;
        box-shadow: 0 18px 48px rgba(0, 0, 0, 0.08);
      }
      h1 {
        margin-top: 0;
        margin-bottom: 0.75rem;
        font-size: clamp(2rem, 5vw, 2.75rem);
      }
      p.description {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #4a4a4a;
      }
      form {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      input[type="file"] {
        flex: 1 1 280px;
      }
      button {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        background: linear-gradient(135deg, #2a4b8d, #5f8df1);
        color: white;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .button-secondary {
        background: linear-gradient(135deg, #394151, #5b708f);
      }
      button:hover,
      button:focus {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(47, 82, 168, 0.25);
      }
      button[disabled] {
        opacity: 0.65;
        cursor: not-allowed;
        box-shadow: none;
      }
      .messages {
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        background: #ffe6e6;
        color: #8c1a1a;
        display: none;
      }
      .messages.show {
        display: block;
      }
      .status-card {
        padding: 1rem 1.25rem;
        border-radius: 12px;
        background: #edf2ff;
        color: #1a2b5c;
        border: 1px solid rgba(42, 75, 141, 0.18);
        display: none;
        margin-bottom: 1.5rem;
      }
      .status-card.show {
        display: block;
      }
      .status-header {
        display: flex;
        justify-content: space-between;
        gap: 0.75rem;
        align-items: center;
      }
      .progress {
        margin-top: 0.75rem;
        height: 10px;
        border-radius: 999px;
        background: rgba(42, 75, 141, 0.2);
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        width: 0;
        background: linear-gradient(135deg, #2a4b8d, #5f8df1);
        transition: width 0.3s ease;
      }
      .result-card {
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: #f7f9fc;
        border-radius: 12px;
        border: 1px solid rgba(42, 75, 141, 0.12);
        display: none;
      }
      .result-card.show {
        display: block;
      }
      .result-card h2 {
        margin-top: 0;
      }
      pre {
        max-height: 420px;
        overflow: auto;
        padding: 1rem;
        background: #10162f;
        color: #e6edf7;
        border-radius: 12px;
        font-size: 0.9rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
      }
      th, td {
        text-align: left;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      }
      th {
        background: rgba(42, 75, 141, 0.08);
      }
      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }
      .image-card {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(42, 75, 141, 0.12);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.75rem;
      }
      .image-card img {
        width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
      }
      .image-card figcaption {
        font-size: 0.85rem;
        color: #4a4a4a;
        text-align: center;
      }
      .actions {
        margin-bottom: 1rem;
      }
      .params {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
      }
      .chip {
        padding: 0.5rem 0.75rem;
        border-radius: 999px;
        background: rgba(42, 75, 141, 0.12);
      }
      footer {
        margin-top: 2rem;
        font-size: 0.85rem;
        color: #6f6f6f;
        text-align: center;
      }
      @media (prefers-color-scheme: dark) {
        body {
          background: #0b101b;
          color: #e6edf7;
        }
        .container {
          background: #111b2e;
          box-shadow: none;
        }
        p.description {
          color: #9ba7c0;
        }
        .result-card {
          background: #0c1322;
          border-color: rgba(95, 141, 241, 0.2);
        }
        pre {
          background: #070b14;
          color: #d6def5;
        }
        table th {
          background: rgba(95, 141, 241, 0.1);
        }
        .image-card {
          background: #0c1322;
        }
        .image-card figcaption {
          color: #9ba7c0;
        }
        .messages {
          background: rgba(255, 118, 118, 0.12);
          color: #ff8888;
        }
        .status-card {
          background: rgba(95, 141, 241, 0.16);
          color: #dce7ff;
          border-color: rgba(95, 141, 241, 0.4);
        }
        .progress {
          background: rgba(95, 141, 241, 0.28);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Skalu Structure Detector</h1>
      <p class="description">Upload a PDF or image to detect horizontal lines and rectangles. The detected structures will be displayed with real-time progress updates.</p>

      <div id="error" class="messages"></div>

      <form id="upload-form" enctype="multipart/form-data">
        <input type="file" name="file" id="file-input" accept="application/pdf,image/*" required>
        <button type="submit" id="analyze-button">Analyze</button>
      </form>

      <div id="status-card" class="status-card">
        <div class="status-header">
          <strong id="status-filename">Waiting for upload…</strong>
          <span id="status-message"></span>
        </div>
        <div class="progress" aria-hidden="true">
          <div id="progress-fill" class="progress-fill"></div>
        </div>
      </div>

      <section id="summary-card" class="result-card"></section>
      <section id="params-card" class="result-card"></section>
      <section id="json-card" class="result-card"></section>
      <section id="viz-card" class="result-card"></section>
      <section id="debug-card" class="result-card"></section>

      <footer>
        Ready for deployment on <strong>Render</strong>. Configure your service to run <code>gunicorn app:app</code> after installing dependencies with <code>pip install -r requirements.txt</code>.
      </footer>
    </div>

    <script>
      const form = document.getElementById('upload-form');
      const fileInput = document.getElementById('file-input');
      const analyzeButton = document.getElementById('analyze-button');
      const errorBox = document.getElementById('error');
      const statusCard = document.getElementById('status-card');
      const statusFilename = document.getElementById('status-filename');
      const statusMessage = document.getElementById('status-message');
      const progressFill = document.getElementById('progress-fill');
      const summaryCard = document.getElementById('summary-card');
      const paramsCard = document.getElementById('params-card');
      const jsonCard = document.getElementById('json-card');
      const vizCard = document.getElementById('viz-card');
      const debugCard = document.getElementById('debug-card');

      let currentJobId = null;
      let pollTimer = null;
      let currentResult = null;

      function resetView() {
        hideError();
        if (pollTimer) {
          window.clearInterval(pollTimer);
          pollTimer = null;
        }
        currentJobId = null;
        [summaryCard, paramsCard, jsonCard, vizCard, debugCard].forEach(section => {
          section.classList.remove('show');
          section.innerHTML = '';
        });
        statusCard.classList.remove('show');
        progressFill.style.width = '0%';
        statusMessage.textContent = '';
        statusFilename.textContent = 'Waiting for upload…';
        currentResult = null;
        analyzeButton.disabled = false;
      }

      function showError(message) {
        errorBox.textContent = message;
        errorBox.classList.add('show');
      }

      function hideError() {
        errorBox.classList.remove('show');
        errorBox.textContent = '';
      }

      async function startAnalysis(event) {
        event.preventDefault();
        resetView();
        hideError();

        if (!fileInput.files || fileInput.files.length === 0) {
          showError('Please choose a PDF or image file to analyze.');
          return;
        }

        analyzeButton.disabled = true;
        statusCard.classList.add('show');
        statusFilename.textContent = fileInput.files[0].name;
        statusMessage.textContent = 'Uploading…';
        progressFill.style.width = '5%';

        try {
          const formData = new FormData(form);
          const response = await fetch('/analyze', {
            method: 'POST',
            body: formData,
          });

          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            throw new Error(payload.error || 'Failed to start analysis.');
          }

          const payload = await response.json();
          currentJobId = payload.job_id;
          statusMessage.textContent = 'Queued';
          progressFill.style.width = '10%';

          pollTimer = window.setInterval(() => checkProgress(currentJobId), 1000);
          await checkProgress(currentJobId);
        } catch (err) {
          showError(err.message || 'Unexpected error.');
          analyzeButton.disabled = false;
          statusCard.classList.remove('show');
        }
      }

      async function checkProgress(jobId) {
        if (!jobId) {
          return;
        }

        try {
          const response = await fetch(`/progress/${jobId}`);
          if (!response.ok) {
            throw new Error('Unable to fetch progress.');
          }
          const payload = await response.json();

          statusMessage.textContent = payload.message || 'Processing…';
          statusFilename.textContent = payload.filename || statusFilename.textContent;

          if (payload.total && payload.total > 0) {
            const percent = Math.min(100, Math.max(0, Math.round((payload.processed / payload.total) * 100)));
            progressFill.style.width = `${percent}%`;
          } else {
            progressFill.style.width = '30%';
          }

          if (payload.status === 'error') {
            throw new Error(payload.error || 'Processing failed.');
          }

          if (payload.result_ready) {
            window.clearInterval(pollTimer);
            pollTimer = null;
            await fetchResults(jobId);
          }
        } catch (err) {
          if (pollTimer) {
            window.clearInterval(pollTimer);
            pollTimer = null;
          }
          showError(err.message || 'Unexpected error while tracking progress.');
          analyzeButton.disabled = false;
          statusMessage.textContent = 'Failed';
          progressFill.style.width = '0%';
        }
      }

      async function fetchResults(jobId) {
        try {
          const response = await fetch(`/results/${jobId}`);
          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            throw new Error(payload.error || 'Unable to fetch results.');
          }

          const payload = await response.json();
          renderResults(payload);
          analyzeButton.disabled = false;
          progressFill.style.width = '100%';
          statusMessage.textContent = 'Processing complete';
        } catch (err) {
          showError(err.message || 'Unable to fetch results.');
          analyzeButton.disabled = false;
        }
      }

      function renderResults(data) {
        currentResult = data;

        if (data.summary) {
          summaryCard.classList.add('show');
          summaryCard.innerHTML = buildSummaryMarkup(data.summary, data.processed_filename);
        }

        if (data.detection_params) {
          paramsCard.classList.add('show');
          paramsCard.innerHTML = buildParamsMarkup(data.detection_params);
        }

        if (data.result_json) {
          jsonCard.classList.add('show');
          jsonCard.innerHTML = `
            <h2>Raw JSON Output</h2>
            <div class="actions">
              <button type="button" class="button-secondary" id="download-button">Download JSON</button>
            </div>
            <pre>${escapeHtml(data.result_json)}</pre>
          `;
          const downloadButton = document.getElementById('download-button');
          downloadButton.addEventListener('click', downloadResults);
        }

        if (Array.isArray(data.visualizations) && data.visualizations.length > 0) {
          vizCard.classList.add('show');
          vizCard.innerHTML = `
            <h2>Detections Preview</h2>
            <div class="image-grid">
              ${data.visualizations.map(viz => `
                <figure class="image-card">
                  <img src="${viz.data_url}" alt="${escapeHtml(viz.label)}">
                  <figcaption>${escapeHtml(viz.label)}</figcaption>
                </figure>
              `).join('')}
            </div>
          `;
        }

        if (Array.isArray(data.debug_groups) && data.debug_groups.length > 0) {
          debugCard.classList.add('show');
          debugCard.innerHTML = `
            <h2>Debug Steps</h2>
            ${data.debug_groups.map(group => `
              <h3>${escapeHtml(group.title)}</h3>
              <div class="image-grid">
                ${group.images.map(image => `
                  <figure class="image-card">
                    <img src="${image.data_url}" alt="${escapeHtml(image.name)}">
                    <figcaption>${escapeHtml(image.name)}</figcaption>
                  </figure>
                `).join('')}
              </div>
            `).join('')}
          `;
        }
      }

      function buildSummaryMarkup(summary, filename) {
        if (summary.type === 'image') {
          const rows = summary.items.map(item => `
            <tr>
              <td>${escapeHtml(item.name)}</td>
              <td>${item.lines}</td>
              <td>${item.rectangles}</td>
              <td>${item.dimensions && item.dimensions[0] && item.dimensions[1] ? `${item.dimensions[0]} × ${item.dimensions[1]}` : '—'}</td>
            </tr>
          `).join('');
          return `
            <h2>Summary for ${escapeHtml(filename || 'image')}</h2>
            <table>
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Horizontal Lines</th>
                  <th>Rectangles</th>
                  <th>Dimensions (px)</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          `;
        }

        if (summary.type === 'pdf') {
          const rows = summary.pages.map(page => `
            <tr>
              <td>${page.page}</td>
              <td>${page.lines}</td>
              <td>${page.rectangles}</td>
              <td>${page.size && page.size[0] && page.size[1] ? `${page.size[0]} × ${page.size[1]}` : '—'}</td>
            </tr>
          `).join('');
          return `
            <h2>Summary for ${escapeHtml(filename || 'document')}</h2>
            <table>
              <thead>
                <tr>
                  <th>Page</th>
                  <th>Horizontal Lines</th>
                  <th>Rectangles</th>
                  <th>Size (px)</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          `;
        }

        return '';
      }

      function buildParamsMarkup(params) {
        const chips = Object.entries(params).map(([key, value]) => `<div class="chip">${escapeHtml(key)}: ${value}</div>`).join('');
        return `
          <h2>Detection Parameters</h2>
          <div class="params">${chips}</div>
        `;
      }

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function downloadResults() {
        if (!currentResult || !currentResult.result_json) {
          return;
        }
        const blob = new Blob([currentResult.result_json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement('a');
        const filename = currentResult.download_filename || 'results.json';
        anchor.href = url;
        anchor.download = filename;
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        URL.revokeObjectURL(url);
      }

      form.addEventListener('submit', startAnalysis);
      fileInput.addEventListener('change', resetView);
    </script>
  </body>
</html>
