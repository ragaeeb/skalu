<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Skalu Demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        color-scheme: light dark;
        --gradient-start: #0f172a;
        --gradient-end: #1e293b;
        --accent: #60a5fa;
        --accent-strong: #2563eb;
        --text-strong: #0f172a;
        --text-muted: #475569;
        --surface: rgba(255, 255, 255, 0.92);
        --surface-border: rgba(148, 163, 184, 0.35);
        --shadow: 0 28px 60px rgba(15, 23, 42, 0.18);
        --radius: 20px;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --gradient-start: #020617;
          --gradient-end: #0f172a;
          --accent: #93c5fd;
          --accent-strong: #3b82f6;
          --text-strong: #e2e8f0;
          --text-muted: #94a3b8;
          --surface: rgba(15, 23, 42, 0.78);
          --surface-border: rgba(148, 163, 184, 0.35);
          --shadow: 0 18px 45px rgba(2, 6, 23, 0.65);
        }
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top right, rgba(96, 165, 250, 0.28), transparent 55%),
                    radial-gradient(circle at 15% 20%, rgba(248, 113, 113, 0.25), transparent 45%),
                    linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        color: var(--text-strong);
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: clamp(1rem, 3vw, 2rem);
        position: relative;
        overflow-x: hidden;
      }

      body::before,
      body::after {
        content: "";
        position: fixed;
        width: 520px;
        height: 520px;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(96, 165, 250, 0.24), transparent 65%);
        filter: blur(80px);
        z-index: 0;
        opacity: 0.65;
        pointer-events: none;
      }

      body::before {
        top: -140px;
        right: -160px;
      }

      body::after {
        bottom: -200px;
        left: -160px;
        background: radial-gradient(circle, rgba(248, 113, 113, 0.2), transparent 65%);
      }

      main {
        position: relative;
        z-index: 1;
        width: 100%;
        max-width: 1400px;
        background: var(--surface);
        border: 1px solid var(--surface-border);
        box-shadow: var(--shadow);
        border-radius: var(--radius);
        overflow: hidden;
        display: grid;
        grid-template-columns: 1fr;
      }

      @media (min-width: 900px) {
        main {
          grid-template-columns: minmax(320px, 400px) 1fr;
        }
      }

      .intro-panel {
        padding: clamp(1.5rem, 4vw, 2.5rem);
        background: linear-gradient(180deg, rgba(96, 165, 250, 0.14), rgba(96, 165, 250, 0.04));
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        position: relative;
        overflow: hidden;
      }

      @media (min-width: 900px) {
        .intro-panel {
          border-bottom: none;
          border-right: 1px solid rgba(148, 163, 184, 0.25);
        }
      }

      .intro-panel::before {
        content: "";
        position: absolute;
        inset: clamp(1.5rem, 4vw, 3rem);
        border-radius: clamp(16px, 3vw, 30px);
        background: radial-gradient(circle at top left, rgba(96, 165, 250, 0.22), transparent 70%);
        opacity: 0.8;
        pointer-events: none;
      }

      .intro-content {
        position: relative;
      }

      h1 {
        font-size: clamp(1.75rem, 5vw, 2.5rem);
        margin: 0 0 0.75rem;
        letter-spacing: -0.02em;
        line-height: 1.2;
      }

      .tagline {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(96, 165, 250, 0.16);
        color: var(--accent-strong);
        border-radius: 999px;
        padding: 0.3rem 0.8rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.75rem;
      }

      .description {
        margin: 1rem 0 1.5rem;
        color: var(--text-muted);
        line-height: 1.6;
        font-size: 0.95rem;
      }

      .feature-grid {
        display: grid;
        gap: 0.85rem;
        margin-top: 1.5rem;
      }

      .feature-card {
        display: flex;
        gap: 0.75rem;
        align-items: flex-start;
        padding: 0.85rem 1rem;
        border-radius: clamp(12px, 2vw, 16px);
        background: rgba(255, 255, 255, 0.72);
        border: 1px solid rgba(148, 163, 184, 0.35);
        backdrop-filter: blur(16px);
        color: var(--text-strong);
        box-shadow: 0 8px 16px rgba(15, 23, 42, 0.06);
      }

      @media (prefers-color-scheme: dark) {
        .feature-card {
          background: rgba(15, 23, 42, 0.64);
        }
      }

      .feature-icon {
        width: 36px;
        height: 36px;
        flex: none;
        display: grid;
        place-items: center;
        border-radius: 10px;
        background: linear-gradient(135deg, rgba(96, 165, 250, 0.28), rgba(37, 99, 235, 0.5));
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .feature-card h3 {
        margin: 0 0 0.25rem;
        font-size: 0.95rem;
      }

      .feature-card p {
        margin: 0;
        font-size: 0.85rem;
        color: var(--text-muted);
        line-height: 1.5;
      }

      .interaction-panel {
        padding: clamp(1.5rem, 4vw, 2.5rem);
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        overflow-y: auto;
        max-height: calc(100vh - 4rem);
      }

      form {
        display: grid;
        gap: 0.85rem;
        background: rgba(15, 23, 42, 0.03);
        border-radius: clamp(14px, 2vw, 18px);
        padding: 1.25rem;
        border: 1px dashed rgba(148, 163, 184, 0.4);
      }

      form label {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      input[type="file"] {
        width: 100%;
        padding: 0.75rem 0.9rem;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(255, 255, 255, 0.65);
        color: inherit;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem;
        align-items: center;
      }

      button {
        padding: 0.75rem 1.5rem;
        font-size: 0.95rem;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        background: linear-gradient(135deg, var(--accent-strong), var(--accent));
        color: white;
        font-weight: 600;
        letter-spacing: 0.01em;
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        box-shadow: 0 12px 28px rgba(37, 99, 235, 0.2);
      }

      button:hover:not([disabled]),
      button:focus:not([disabled]) {
        transform: translateY(-2px);
        box-shadow: 0 18px 36px rgba(37, 99, 235, 0.28);
      }

      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
        filter: grayscale(0.2);
        box-shadow: none;
      }

      .button-secondary {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.85));
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.15);
      }

      .messages {
        margin: 0;
        padding: 0.85rem 1rem;
        border-radius: clamp(12px, 2vw, 16px);
        background: rgba(248, 113, 113, 0.18);
        color: #9f1239;
        border: 1px solid rgba(248, 113, 113, 0.35);
        font-weight: 500;
        font-size: 0.9rem;
        display: none;
      }

      .messages.show {
        display: block;
      }

      .status-card {
        padding: 1.2rem 1.35rem;
        border-radius: clamp(14px, 2vw, 18px);
        background: rgba(96, 165, 250, 0.16);
        border: 1px solid rgba(37, 99, 235, 0.35);
        display: none;
        position: relative;
        overflow: hidden;
      }

      .status-card::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.08), transparent);
        pointer-events: none;
      }

      .status-card.show {
        display: block;
      }

      .status-header {
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem;
        align-items: center;
        justify-content: space-between;
      }

      .status-title {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        min-width: 0;
        flex: 1;
      }

      .status-title strong {
        font-size: 0.95rem;
        word-break: break-word;
      }

      .status-message {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.85rem;
        color: var(--accent-strong);
        font-weight: 600;
        white-space: nowrap;
      }

      .status-message .pulse {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--accent-strong);
        animation: pulse 1.4s ease-in-out infinite;
        box-shadow: 0 0 0 rgba(37, 99, 235, 0.45);
      }

      @keyframes pulse {
        0% {
          transform: scale(0.85);
          box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.45);
        }
        70% {
          transform: scale(1);
          box-shadow: 0 0 0 8px rgba(37, 99, 235, 0);
        }
        100% {
          transform: scale(0.85);
          box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
        }
      }

      .progress {
        margin-top: 0.85rem;
        height: 8px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.35);
        overflow: hidden;
        position: relative;
      }

      .progress-fill {
        height: 100%;
        width: 0;
        background: linear-gradient(120deg, var(--accent-strong), var(--accent));
        transition: width 0.4s ease;
      }

      .progress-fill::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.35), transparent 60%);
        mix-blend-mode: screen;
        opacity: 0.6;
      }

      .result-section {
        display: none;
        border-radius: clamp(14px, 2vw, 18px);
        background: rgba(255, 255, 255, 0.78);
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 1.5rem;
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.06);
      }

      @media (prefers-color-scheme: dark) {
        .result-section {
          background: rgba(15, 23, 42, 0.7);
        }
      }

      .result-section.show {
        display: block;
      }

      .result-section h2 {
        margin-top: 0;
        margin-bottom: 0.65rem;
        font-size: 1.2rem;
        display: flex;
        gap: 0.45rem;
        align-items: center;
      }

      .result-section h2 span {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 9px;
        background: rgba(96, 165, 250, 0.16);
        color: var(--accent-strong);
        font-size: 0.9rem;
        font-weight: 600;
      }

      .result-section h3 {
        font-size: 1rem;
        margin: 1.5rem 0 0.75rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 0.85rem 0 0;
        border-radius: 12px;
        overflow: hidden;
        font-size: 0.9rem;
      }

      th,
      td {
        text-align: left;
        padding: 0.65rem 0.8rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      }

      th {
        background: rgba(148, 163, 184, 0.18);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
      }

      pre {
        max-height: 360px;
        overflow: auto;
        padding: 1rem;
        border-radius: 12px;
        background: #0f172a;
        color: #e2e8f0;
        font-size: 0.85rem;
        line-height: 1.5;
        margin-top: 0.85rem;
      }

      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1.25rem;
      }

      .image-card {
        background: rgba(255, 255, 255, 0.85);
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.3);
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 0.55rem;
        padding: 0.75rem;
      }

      @media (prefers-color-scheme: dark) {
        .image-card {
          background: rgba(15, 23, 42, 0.7);
        }
      }

      .image-card img {
        width: 100%;
        height: auto;
        border-radius: 10px;
        box-shadow: 0 8px 16px rgba(15, 23, 42, 0.12);
      }

      .image-card figcaption {
        font-size: 0.8rem;
        color: var(--text-muted);
        text-align: center;
        word-break: break-word;
      }

      .params {
        display: flex;
        flex-wrap: wrap;
        gap: 0.55rem;
        margin-top: 0.85rem;
      }

      .chip {
        padding: 0.5rem 0.8rem;
        border-radius: 999px;
        background: rgba(96, 165, 250, 0.16);
        color: var(--accent-strong);
        font-weight: 500;
        font-size: 0.85rem;
      }

      footer {
        margin-top: auto;
        padding-top: 1rem;
        font-size: 0.8rem;
        color: var(--text-muted);
        text-align: center;
        line-height: 1.5;
      }

      footer a {
        color: inherit;
        font-weight: 600;
        text-decoration: none;
      }

      .results-stack {
        display: grid;
        gap: 1.25rem;
      }

      .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        margin-top: 0.85rem;
      }

      .stat-card {
        padding: 0.85rem 1rem;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.3);
        display: grid;
        gap: 0.3rem;
      }

      @media (prefers-color-scheme: dark) {
        .stat-card {
          background: rgba(15, 23, 42, 0.7);
        }
      }

      .stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
      }

      .stat-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-strong);
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.3rem 0.65rem;
        border-radius: 999px;
        background: rgba(96, 165, 250, 0.14);
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--accent-strong);
      }

      .lead-in {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
      }
    </style>
  </head>
  <body>
    <main>
      <section class="intro-panel">
        <div class="intro-content">
          <span class="tagline">Real-time PDF &amp; image insights</span>
          <h1>Skalu Structure Detector</h1>
          <p class="description">
            Upload a PDF or individual image and Skalu will highlight every rectangle and horizontal line we find.
            Watch the job progress in real time and explore rich debug visualizations as soon as each run completes.
          </p>

          <div class="feature-grid">
            <article class="feature-card">
              <div class="feature-icon">1</div>
              <div>
                <h3>Upload anything</h3>
                <p>Drop in multipage PDFs or single images in common formats like PNG, JPG, TIFF, WebP, and more.</p>
              </div>
            </article>
            <article class="feature-card">
              <div class="feature-icon">2</div>
              <div>
                <h3>Track progress live</h3>
                <p>We process each page asynchronously so long-running jobs keep updating instead of timing out.</p>
              </div>
            </article>
            <article class="feature-card">
              <div class="feature-icon">3</div>
              <div>
                <h3>Download and debug</h3>
                <p>Inspect detection parameters, review visualization grids, and download the full JSON payload instantly.</p>
              </div>
            </article>
          </div>
        </div>
      </section>

      <section class="interaction-panel">
        <form id="upload-form" enctype="multipart/form-data">
          <label for="file-input">Choose a PDF or image to analyze</label>
          <input type="file" name="file" id="file-input" accept="application/pdf,image/*" required>
          <div class="button-row">
            <button type="submit" id="analyze-button">Analyze document</button>
          </div>
        </form>

        <p id="error" class="messages"></p>

        <article id="status-card" class="status-card">
          <div class="status-header">
            <div class="status-title">
              <span class="badge">Analyzing</span>
              <strong id="status-filename">Waiting for upload…</strong>
            </div>
            <span id="status-message" class="status-message"><span class="pulse" aria-hidden="true"></span>Ready</span>
          </div>
          <div class="progress" aria-hidden="true">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
        </article>

        <div class="results-stack">
          <section id="summary-card" class="result-section"></section>
          <section id="params-card" class="result-section"></section>
          <section id="json-card" class="result-section"></section>
          <section id="viz-card" class="result-section"></section>
          <section id="debug-card" class="result-section"></section>
        </div>

        <footer>
          Ready for deployment on <strong>Render</strong>. Configure your service to run <code>gunicorn app:app</code>
          after installing dependencies with <code>pip install -r requirements.txt</code>.
        </footer>
      </section>
    </main>

    <script>
      const form = document.getElementById('upload-form');
      const fileInput = document.getElementById('file-input');
      const analyzeButton = document.getElementById('analyze-button');
      const errorBox = document.getElementById('error');
      const statusCard = document.getElementById('status-card');
      const statusFilename = document.getElementById('status-filename');
      const statusMessage = document.getElementById('status-message');
      const progressFill = document.getElementById('progress-fill');
      const summaryCard = document.getElementById('summary-card');
      const paramsCard = document.getElementById('params-card');
      const jsonCard = document.getElementById('json-card');
      const vizCard = document.getElementById('viz-card');
      const debugCard = document.getElementById('debug-card');

      let currentJobId = null;
      let pollTimer = null;
      let currentResult = null;

      function resetView() {
        hideError();
        if (pollTimer) {
          window.clearInterval(pollTimer);
          pollTimer = null;
        }
        currentJobId = null;
        [summaryCard, paramsCard, jsonCard, vizCard, debugCard].forEach(section => {
          section.classList.remove('show');
          section.innerHTML = '';
        });
        statusCard.classList.remove('show');
        progressFill.style.width = '0%';
        statusMessage.innerHTML = '<span class="pulse" aria-hidden="true"></span>Ready';
        statusFilename.textContent = 'Waiting for upload…';
        currentResult = null;
        analyzeButton.disabled = false;
      }

      function showError(message) {
        errorBox.textContent = message;
        errorBox.classList.add('show');
      }

      function hideError() {
        errorBox.classList.remove('show');
        errorBox.textContent = '';
      }

      async function startAnalysis(event) {
        event.preventDefault();
        resetView();
        hideError();

        if (!fileInput.files || fileInput.files.length === 0) {
          showError('Please choose a PDF or image file to analyze.');
          return;
        }

        analyzeButton.disabled = true;
        statusCard.classList.add('show');
        statusFilename.textContent = fileInput.files[0].name;
        statusMessage.innerHTML = '<span class="pulse" aria-hidden="true"></span>Uploading…';
        progressFill.style.width = '6%';

        try {
          const formData = new FormData(form);
          const response = await fetch('/analyze', {
            method: 'POST',
            body: formData,
          });

          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            throw new Error(payload.error || 'Failed to start analysis.');
          }

          const payload = await response.json();
          currentJobId = payload.job_id;
          statusMessage.innerHTML = '<span class="pulse" aria-hidden="true"></span>Queued';
          progressFill.style.width = '12%';

          pollTimer = window.setInterval(() => checkProgress(currentJobId), 1000);
          await checkProgress(currentJobId);
        } catch (err) {
          showError(err.message || 'Unexpected error.');
          analyzeButton.disabled = false;
          statusCard.classList.remove('show');
        }
      }

      async function checkProgress(jobId) {
        if (!jobId) {
          return;
        }

        try {
          const response = await fetch(`/progress/${jobId}`);
          if (!response.ok) {
            throw new Error('Unable to fetch progress.');
          }
          const payload = await response.json();

          statusFilename.textContent = payload.filename || statusFilename.textContent;
          statusMessage.innerHTML = `<span class="pulse" aria-hidden="true"></span>${escapeHtml(payload.message || 'Processing…')}`;

          if (payload.total && payload.total > 0) {
            const percent = Math.min(100, Math.max(0, Math.round((payload.processed / payload.total) * 100)));
            progressFill.style.width = `${percent}%`;
          } else {
            progressFill.style.width = '35%';
          }

          if (payload.status === 'error') {
            throw new Error(payload.error || 'Processing failed.');
          }

          if (payload.result_ready) {
            window.clearInterval(pollTimer);
            pollTimer = null;
            await fetchResults(jobId);
          }
        } catch (err) {
          if (pollTimer) {
            window.clearInterval(pollTimer);
            pollTimer = null;
          }
          showError(err.message || 'Unexpected error while tracking progress.');
          analyzeButton.disabled = false;
          statusMessage.innerHTML = '<span class="pulse" aria-hidden="true"></span>Failed';
          progressFill.style.width = '0%';
        }
      }

      async function fetchResults(jobId) {
        try {
          const response = await fetch(`/results/${jobId}`);
          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            throw new Error(payload.error || 'Unable to fetch results.');
          }

          const payload = await response.json();
          renderResults(payload);
          analyzeButton.disabled = false;
          progressFill.style.width = '100%';
          statusMessage.innerHTML = '<span class="pulse" aria-hidden="true"></span>Processing complete';
        } catch (err) {
          showError(err.message || 'Unable to fetch results.');
          analyzeButton.disabled = false;
        }
      }

      function renderResults(data) {
        currentResult = data;

        if (data.summary) {
          summaryCard.classList.add('show');
          summaryCard.innerHTML = buildSummaryMarkup(data.summary, data.processed_filename);
        }

        if (data.detection_params) {
          paramsCard.classList.add('show');
          paramsCard.innerHTML = buildParamsMarkup(data.detection_params);
        }

        if (data.result_json) {
          jsonCard.classList.add('show');
          jsonCard.innerHTML = `
            <h2><span>JSON</span>Raw output</h2>
            <p class="lead-in">Download the structured detections or browse the formatted payload below.</p>
            <div class="button-row">
              <button type="button" class="button-secondary" id="download-button">Download JSON</button>
            </div>
            <pre>${escapeHtml(data.result_json)}</pre>
          `;
          const downloadButton = document.getElementById('download-button');
          downloadButton.addEventListener('click', downloadResults);
        }

        if (Array.isArray(data.visualizations) && data.visualizations.length > 0) {
          vizCard.classList.add('show');
          vizCard.innerHTML = `
            <h2><span>Viz</span>Detections preview</h2>
            <p class="lead-in">Review the annotated output for each page or image to see what Skalu detected.</p>
            <div class="image-grid">
              ${data.visualizations.map(viz => `
                <figure class="image-card">
                  <img src="${viz.data_url}" alt="${escapeHtml(viz.label)}">
                  <figcaption>${escapeHtml(viz.label)}</figcaption>
                </figure>
              `).join('')}
            </div>
          `;
        }

        if (Array.isArray(data.debug_groups) && data.debug_groups.length > 0) {
          debugCard.classList.add('show');
          debugCard.innerHTML = `
            <h2><span>Debug</span>Processing steps</h2>
            <p class="lead-in">Dive into intermediate frames to understand how each page was segmented.</p>
            ${data.debug_groups.map(group => `
              <h3>${escapeHtml(group.title)}</h3>
              <div class="image-grid">
                ${group.images.map(image => `
                  <figure class="image-card">
                    <img src="${image.data_url}" alt="${escapeHtml(image.name)}">
                    <figcaption>${escapeHtml(image.name)}</figcaption>
                  </figure>
                `).join('')}
              </div>
            `).join('')}
          `;
        }
      }

      function buildSummaryMarkup(summary, filename) {
        if (summary.type === 'image') {
          const rows = summary.items.map(item => `
            <tr>
              <td>${escapeHtml(item.name)}</td>
              <td>${item.lines}</td>
              <td>${item.rectangles}</td>
              <td>${item.dimensions && item.dimensions[0] && item.dimensions[1] ? `${item.dimensions[0]} × ${item.dimensions[1]}` : '—'}</td>
            </tr>
          `).join('');
          return `
            <h2><span>Summary</span>${escapeHtml(filename || 'image')}</h2>
            <p class="lead-in">Overview of detected structures across your uploaded image.</p>
            <table>
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Horizontal lines</th>
                  <th>Rectangles</th>
                  <th>Dimensions (px)</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          `;
        }

        if (summary.type === 'pdf') {
          const totalPages = summary.pages.length;
          const totalLines = summary.pages.reduce((sum, page) => sum + (page.lines || 0), 0);
          const totalRects = summary.pages.reduce((sum, page) => sum + (page.rectangles || 0), 0);
          const rows = summary.pages.map(page => `
            <tr>
              <td>${page.page}</td>
              <td>${page.lines}</td>
              <td>${page.rectangles}</td>
              <td>${page.size && page.size[0] && page.size[1] ? `${page.size[0]} × ${page.size[1]}` : '—'}</td>
            </tr>
          `).join('');
          return `
            <h2><span>Summary</span>${escapeHtml(filename || 'document')}</h2>
            <div class="stats-row">
              <div class="stat-card">
                <span class="stat-label">Pages processed</span>
                <span class="stat-value">${totalPages}</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Horizontal lines</span>
                <span class="stat-value">${totalLines}</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Rectangles</span>
                <span class="stat-value">${totalRects}</span>
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Page</th>
                  <th>Horizontal lines</th>
                  <th>Rectangles</th>
                  <th>Size (px)</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          `;
        }

        return '';
      }

      function buildParamsMarkup(params) {
        const chips = Object.entries(params)
          .map(([key, value]) => `<div class="chip">${escapeHtml(key)}: ${escapeHtml(value)}</div>`)
          .join('');
        return `
          <h2><span>Config</span>Detection parameters</h2>
          <p class="lead-in">These thresholds and ratios were applied while scanning your document.</p>
          <div class="params">${chips}</div>
        `;
      }

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function downloadResults() {
        if (!currentResult || !currentResult.result_json) {
          return;
        }
        const blob = new Blob([currentResult.result_json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement('a');
        const filename = currentResult.download_filename || 'results.json';
        anchor.href = url;
        anchor.download = filename;
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        URL.revokeObjectURL(url);
      }

      form.addEventListener('submit', startAnalysis);
      fileInput.addEventListener('change', resetView);
    </script>
  </body>
</html>