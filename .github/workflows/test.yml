name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1 \
          libglib2.0-0 \
          libsm6 \
          libxext6 \
          libxrender-dev \
          libgomp1

    - name: Set up Python 3.13
      uses: actions/setup-python@v6
      with:
        python-version: "3.13"

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install dependencies with uv
      run: |
        # Install all runtime dependencies explicitly (uv doesn't handle -e . dependencies well)
        uv pip install --system \
          opencv-python-headless>=4.12.0.88 \
          numpy>=1.24.0 \
          pymupdf>=1.23.0 \
          pillow>=12.0.0 \
          tqdm>=4.66.0 \
          flask>=3.1.2 \
          werkzeug>=3.1.3 \
          streamlit>=1.51.0
        # Install test dependencies
        uv pip install --system pytest>=7.0.0 pytest-cov>=3.0.0
        # Install package in editable mode (without dependencies since we installed them above)
        uv pip install --system --no-deps -e .
        
    - name: Verify installation
      run: |
        python -c "import cv2; print(f'OpenCV version: {cv2.__version__}')"
        python -c "import numpy; print(f'NumPy version: {numpy.__version__}')"
        python -c "import pytest; print(f'pytest version: {pytest.__version__}')"
        python -c "import skalu; print(f'Skalu version: {skalu.__version__}')"

    - name: Run tests with pytest
      run: |
        python -m pytest tests/ -v --cov=skalu --cov-report=term-missing --cov-report=xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false